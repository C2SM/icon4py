# ICON4Py Model

This folder contains Python implementations for multiple ICON components.

It includes the following packages:

- `atmosphere/dycore`: Contains implementations of the dynamical core of the ICON model
- `atmosphere/diffusion`: Contains the implementation of diffusion in the ICON model
- `common`: Contains shared functionality that is required by multiple components.
- `driver`: Contains the driving code for the model

## Installation Instructions

You can follow the general installation instructions used for the entire icon4py repository, or install each namespace package within this folder independently using the individual folder-specific `requirements.txt` or `requirements-dev.txt` files.

In the following example it is assumed that you have already created and activated a virtual environment.

```bash
# changing into the corresponding directory
cd model/atmosphere/dycore

# installing a development version
pip install -r requirements-dev.txt
```

**Note**: For more information specific to each component, please refer to the README in their respective subfolders.

### Testing

See the repository [README](../README.md) for general information.

#### Data dependent tests

Some test depend on serialized data generated by a full model run. 
Those test are marked with `pytest.mark.datatest` and are only run when the `--datatest` 
option is specified. Note that due to `pytests` configuration discovery 
you need to specify the base a package directory i.e. one that contains a `pyproject.toml` for the 
commandline option to work.

```bash

pytest -v --datatest model/common
pytest -v --datatest model/atmosphere/diffusion
```

#### Testing parallel code

Tests for parallel codes using MPI are collected in specific subpackages of the model components test folders (e.g. `diffusion_tests/mpi_tests`). All parallel tests are marked with `@pytest.mark.mpi` and are skipped if the `--with-mpi` is not passed option is not passed to `pytest` In order to run them, you need a MPI installation on your system: On Debian-Linux do

```bash
sudo apt-get install libopenmpi-dev
```

or

```bash
sudo apt-get install mpich
```

on MacOs

```bash
brew install mpich
```

Then you can run the tests with

```bash
mpirun -np 2 pytest -v -s --with-mpi path/to/test/folder/mpi_tests
```
