# ICON4Py Model

This folder contains Python implementations for multiple ICON components.

It includes the following packages:

- `atmosphere/dycore`: Contains implementations of the dynamical core of the ICON model
- `atmosphere/diffusion`: Contains the implementation of diffusion in the ICON model
- `atmosphere/advection`: Contains implementations of the advection component of the ICON model
- `atmosphere/subgrid_scale_physics/microphysics`: Contains implementations of the microphysics and saturation adjustment components of the ICON model
- `common`: Contains shared functionality that is required by multiple components.
- `driver`: Contains the driving code for the model

## Installation instructions

Until the development reaches a stable state, we recommend you to follow the general instructions in the [../README.md](../README.md) root folder to install all model component and all its dependencies in a virtual environment for development.

**Note**: For more information specific to each component, please refer to the README in their respective subfolders.

### Testing

See the repository [README](../README.md) for general information.

#### Unit tests for stencils

The `gt4py` stencils in the `icon4py-model` packages are used for integration into Fortran code
via [icon4pygen](../tools/src/icon4py/icon4pygen). To make integration easier
unit tests for the stencils need to be placed into
a `stencil_tests` subfolder of the packages test path. For example

```
model/atmosphere/diffusion/tests/stencil_tests
model/atmosphere/dycore/tests/stencil_tests
model/atmosphere/advection/tests/stencil_tests
model/common/tests/tests/stencil_tests
```

#### Data dependent tests

Some tests depend on serialized data generated by a full model run.
Those tests are marked with `pytest.mark.datatest` and can be exclusively selected with the `--datatest-only` or skipped
with `--datatest-skip` options. Note that due to `pytest` configuration discovery
you need to specify the base package directory i.e. one that contains a `pyproject.toml` for the
commandline option to work.

```bash

pytest -v --datatest-skip model/common
pytest -v --datatest-only model/atmosphere/diffusion
```

#### Testing parallel code

Icon4Py uses GHEX as communication library. It is an optional dependency of the model. In order to install and
run the parallel version do the following:

1. You need to have a MPI installation in your system, so do the following

```bash
sudo apt-get install libopenmpi-dev
```

or

```bash
sudo apt-get install mpich
```

On MacOS run

```bash
brew install mpich
```

or

```bash
brew install open-mpi
```

2. Install optional python libraries:
   In the main folder of the repository, run

```bash
uv sync --extra distributed 
```

or

```bash
uv sync --extra all 
```

which installs all optional dependencies.

Note that the current Python build for GHEX seems not to run on MacOS.

3. Run parallel tests
   In order to run the parallel tests you need to specify the `--with-mpi` option to `pytest`
   and pass the exact folder location of the tests to `pytest`, or use the `-k mpi_tests` filter.
   Use the `scripts/ci-mpi-wrapper.sh` helper script to avoid cluttering stdout with output
   from all ranks. Output from the the first rank will go to stdout, and the output of all
   ranks will go to rank-specific log files `pytest-log-rank-<rank>.txt`.

```bash
mpirun -np 4 scripts/ci-mpi-wrapper pytest -v -s --with-mpi -k mpi_tests
mpirun -np 4 scripts/ci-mpi-wrapper pytest -v -s --with-mpi model/atmosphere/diffusion/diffusion_tests/mpi_tests/
mpirun -np 4 scripts/ci-mpi-wrapper pytest -v -s --with-mpi model/common/tests/mpi_tests/
```

You can restrict the number of compile process that gt4py uses by setting `GT4PY_BUILD_JOBS` environment variable:
`export GT4PY_BUILD_JOBS=4`
