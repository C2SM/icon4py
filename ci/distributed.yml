include:
  - local: 'ci/base.yml'

.test_template_aarch64_distributed:
  extends: [.container-runner-santis-gh200, .test_template_aarch64]
  needs: [build_image_aarch64]
  variables:
    # run with mpi
    MPI4PY_BUILD_BACKEND: "scikit-build-core"
    MPI4PY_BUILD_MPICC: nvc
    USE_MPI: "YES"
    SLURM_NTASKS: 1



.test_model_distributed:
  stage: test
  before_script:
    - echo ${MPI4PY_BUILD_MPICC}
    - ls ${HPC_SDK_PATH}/compilers/bin
    - ls ${HPC_SDK_PATH}/comm_libs/mpi/bin
  script:
    - uv sync --extra distributed
  parallel:
    matrix:
      - COMPONENT: [ diffusion, common] # [advection, diffusion, dycore, microphysics, common, driver]
        BACKEND: [ gtfn_cpu]
  rules:
    - when: on_success
# test_model_stencils_x86_64:
#   extends: [.test_model_stencils, .test_template_x86_64]
test_model_distributed_aarch64:
  extends: [.test_model_distributed, .test_template_aarch64_distributed]

