include:
  - local: 'ci/base.yml'

.benchmark_model_stencils:
  stage: benchmark
  script:
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source "$HOME/.cargo/env"
    - cargo install --git https://github.com/bencherdev/bencher --branch main --locked --force bencher_cli
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
    - uv sync --no-dev --extra=dace --extra=io --extra=testing --extra=cuda12 --group=test
    - source .venv/bin/activate
    - echo $BENCHER_API_TOKEN $CI_COMMIT_REF_NAME $CI_MERGE_REQUEST_TARGET_BRANCH_NAME $CI_MERGE_REQUEST_TARGET_BRANCH_SHA
    - |
      bencher run \
      --project test-1vcbiy6t \
      --token "$BENCHER_API_TOKEN" \
      --branch "$CI_COMMIT_REF_NAME" \
      --start-point "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" \
      --start-point-hash "$CI_MERGE_REQUEST_TARGET_BRANCH_SHA" \
      --start-point-clone-thresholds \
      --start-point-reset \
      --testbed debian:bullseye \
      --err \
      --adapter python_pytest \
      --file results.json \
      pytest --benchmark-json results.json -sv --benchmark-only --backend=$BACKEND --grid=$GRID
    # - nox -s benchmark_model-3.10 -- --backend=$BACKEND --grid=$GRID
  parallel:
    matrix:
      - BACKEND: [gtfn_cpu, gtfn_gpu]
        GRID: [icon_grid, icon_grid_global]
# benchmark_model_stencils_x86_64:
#   extends: [.benchmark_model_stencils, .test_template_x86_64]
benchmark_model_stencils_aarch64:
  extends: [.benchmark_model_stencils, .test_template_aarch64]
