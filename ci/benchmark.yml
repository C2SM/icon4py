include:
  - local: 'ci/base.yml'

.benchmark_model_stencils:
  stage: benchmark
  variables:
    GIT_STRATEGY: clone
  script:
    - git clone -b asv_test https://github.com/C2SM/icon4py.git
    - cd icon4py
    - echo "Running benchmarks"
    - pip uninstall -y uv || true
    - pip install asv
    - ASV_RESULTS_REPOSITORY="https://iomaganaris:$ICON4PY_ASV_TOKEN@github.com/iomaganaris/icon4py_asv.git"
    - ASV_RESULTS_REPOSITORY_BRANCH="icon4py_upstream_santis"
    - git config --global user.name 'icon4py CI'
    - git config --global user.email 'icon4py@C2SM'
    - git config --global push.default nothing
    - git checkout asv_test
    - git clone -b $ASV_RESULTS_REPOSITORY_BRANCH $ASV_RESULTS_REPOSITORY .asv/results
    - cp asv_util/asv-machine.santis.json $HOME/.asv-machine.json
    # - asv run --environment virtualenv:3.10 -v asv_test^!
    # - pushd .asv/results
    # - git add .
    # - git commit -m "Benchmark results for commit $CI_COMMIT_SHA"
    # - git fetch origin
    # - git rebase origin/$ASV_RESULTS_REPOSITORY_BRANCH
    # - git push origin HEAD:$ASV_RESULTS_REPOSITORY_BRANCH
    # - popd
    # - asv gh-pages --no-push
    # - git push $ASV_RESULTS_REPOSITORY gh-pages:gh-pages -f
    - COMMENT=$(asv compare c714693d e238b628 -m gh200)
    - echo $COMMENT
    - PR_ID=$(echo "${CI_COMMIT_BRANCH}" | grep -o 'pr[0-9]*' | grep -o '[0-9]*')
    - echo $PR_ID
    - |
      if [[ "$PR_ID" != "" ]]; then
        curl -H "Authorization: token $ICON4PY_ASV_TOKEN" \
             -X POST \
             -d "{\"body\": \"$COMMENT\"}" \
             "https://api.github.com/repos/C2SM/icon4py/pulls/$PR_ID/comments"
      else
        echo "No open pull requests found."
      fi
    - |
      if [[ "$(echo $COMMENT | grep -e "runtime" | grep "|[\ ]*+[\ ]*|")" != "" ]]; then
        exit 1
      fi
    - |
      if [[ "$(echo $COMMENT | grep -e "memory" | grep "|[\ ]*+[\ ]*|")" != "" ]]; then
        exit 1
      fi


# benchmark_model_stencils_x86_64:
#   extends: [.benchmark_model_stencils, .test_template_x86_64]
benchmark_model_stencils_aarch64:
  extends: [.benchmark_model_stencils, .test_template_aarch64]
