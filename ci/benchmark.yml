include:
  - local: 'ci/base.yml'

.benchmark_model_stencils:
  stage: benchmark
  script:
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source "$HOME/.cargo/env"
    - cargo install --git https://github.com/finkandreas/bencher --branch main --locked --force bencher_cli
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
    - echo $ICON4PY_NOX_UV_CUSTOM_SESSION_EXTRAS
    - uv sync --no-dev --extra=dace --extra=io --extra=testing --extra=$ICON4PY_NOX_UV_CUSTOM_SESSION_EXTRAS --group=test
    - source .venv/bin/activate
    - export GITHUB_EVENT_NAME=pull_request
    - export GITHUB_STEP_SUMMARY=$CI_PROJECT_DIR/step_summary.log
    - export GITHUB_SHA=$CI_COMMIT_SHA
    - export GITHUB_ACTIONS=true
    - export GITHUB_EVENT_PATH=$CI_PROJECT_DIR/event.json
    - export RUST_LOG=debug
    - cp ./event.json $CI_PROJECT_DIR
    - export BACKEND=gtfn_cpu
    - export GRID=icon_grid
    - bencher run --project test-1vcbiy6t --token "$BENCHER_API_TOKEN" --github-actions $CK_COMMENT_TOKEN --adapter python_pytest --file results.json "pytest --benchmark-json results.json -sv --benchmark-only --backend=$BACKEND --grid=$GRID ./model/atmosphere/diffusion/tests/diffusion_stencil_tests/test_apply_diffusion_to_vn.py"
    - |
      curl -L \
      -H "Accept: application/vnd.github+json" \
      -H "Authorization: Bearer $CK_COMMENT_TOKEN" \
      -H "X-GitHub-Api-Version: 2022-11-28" \
      https://api.github.com/repos/C2SM/icon4py/issues/662/comments
  # parallel:
  #   matrix:
  #     - BACKEND: [gtfn_cpu, gtfn_gpu]
  #       GRID: [icon_grid, icon_grid_global]

# benchmark_model_stencils_x86_64:
#   extends: [.benchmark_model_stencils, .test_template_x86_64]

benchmark_model_stencils_aarch64:
  extends: [.benchmark_model_stencils, .test_template_aarch64]
