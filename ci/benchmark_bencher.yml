include:
  - local: 'ci/base.yml'

.benchmark_model_stencils:
  stage: benchmark
  script:
    - export PR_ID=$(echo "${CI_COMMIT_BRANCH}" | grep -o 'pr[0-9]*' | grep -o '[0-9]*')
    - export FEATURE_BRANCH=$(curl -s https://api.github.com/repos/C2SM/icon4py/pulls/$PR_ID | jq -r '.head.ref')
    - export GITHUB_EVENT_NAME=pull_request # needed for GitHub PR comments - along with --github-actions -
    - export GITHUB_STEP_SUMMARY=$CI_PROJECT_DIR/step_summary.log # needed for GitHub PR comments - along with --github-actions -
    - export GITHUB_SHA=$CI_COMMIT_SHA # needed for GitHub PR comments - along with --github-actions -
    - export GITHUB_ACTIONS=true # needed for GitHub PR comments - along with --github-actions -
    - export GITHUB_EVENT_PATH=$CI_PROJECT_DIR/event.json # needed for GitHub PR comments - along with --github-actions -
    - | # needed for GitHub PR comments - along with --github-actions -
      echo "{\"pull_request\": {\"head\": {\"repo\": {\"full_name\": \"C2SM/icon4py\"}}}, \"repository\": {\"full_name\": \"C2SM/icon4py\"}, \"number\": $PR_ID}" > $CI_PROJECT_DIR/event.json
    - rustup default stable
    - cargo install --git https://github.com/finkandreas/bencher --branch main --locked --force bencher_cli --root /root/.cargo # Specific version of bencher that supports --github-actions | TODO(kotsaloscv): remove once merged
    - nox -s bencher_feature_branch-3.10 -- --backend=$BACKEND --grid=$GRID
    - | # Post the Bencher Dashboard link to the PR
      if [[ "$PR_ID" != "" && "$BACKEND" == "gtfn_cpu" && "$GRID" == "icon_grid" ]]; then
        COMMENT_BODY="[Bencher Dashboard](https://bencher.dev/perf/c2sm-icon4py)"
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: token $GD_COMMENT_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/C2SM/icon4py/issues/$PR_ID/comments \
          -d "{\"body\": \"$COMMENT_BODY\"}"
      fi
  parallel:
    matrix:
      - BACKEND: [gtfn_cpu, gtfn_gpu]
        GRID: [icon_grid, icon_grid_global]

# benchmark_bencher_x86_64:
#   extends: [.benchmark_model_stencils, .test_template_x86_64]

benchmark_bencher_aarch64:
  extends: [.benchmark_model_stencils, .test_template_aarch64]
